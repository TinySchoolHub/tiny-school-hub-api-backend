name: Auto-merge Renovate PRs

on:
  pull_request:
    branches: [develop]

permissions:
  contents: write
  pull-requests: write

jobs:
  auto-merge:
    name: Auto-merge Renovate PRs
    runs-on: ubuntu-latest
    if: github.actor == 'renovate[bot]'
    steps:
      - name: Check PR labels
        id: check-labels
        uses: actions/github-script@f28e40c7f34bde8b3046d885e986cb6290c5673b # v7
        with:
          script: |
            const labels = context.payload.pull_request.labels.map(l => l.name);
            const isAutomerge = labels.includes('automerge');
            const isDependencies = labels.includes('dependencies');
            return isAutomerge && isDependencies;

      - name: Wait for CI
        if: steps.check-labels.outputs.result == 'true'
        uses: lewagon/wait-on-check-action@3603e826ee561ea102b58accb5ea55a1a7482343 # v1.4.1
        with:
          ref: ${{ github.event.pull_request.head.sha }}
          check-regexp: '(Lint|Test|Validate Migrations|Build Docker Image)'
          repo-token: ${{ secrets.GITHUB_TOKEN }}
          wait-interval: 10

      - name: Approve PR
        if: steps.check-labels.outputs.result == 'true'
        uses: hmarr/auto-approve-action@v4
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Enable auto-merge
        if: steps.check-labels.outputs.result == 'true'
        uses: peter-evans/enable-pull-request-automerge@a660677d5469627102a1c1e11409dd063606628d # v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          pull-request-number: ${{ github.event.pull_request.number }}
          merge-method: squash

      - name: Comment on PR
        if: steps.check-labels.outputs.result == 'true'
        uses: actions/github-script@f28e40c7f34bde8b3046d885e986cb6290c5673b # v7
        with:
          github-token: ${{secrets.GITHUB_TOKEN}}
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: 'ðŸ¤– This Renovate PR has been approved and will auto-merge once all checks pass.'
            })
